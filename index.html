<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Procedural Planet Studio</title>
    <link rel="icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/src/landing.css" />
  </head>
  <body>
    <div class="landing">
      <header class="landing__nav">
        <div class="landing__brand">
          <span class="logo-dot" aria-hidden="true"></span>
          <span class="logo-text">Procedural Planet Studio</span>
        </div>
        <!-- <nav class="landing__actions">
          <a class="btn btn-ghost" href="/explore.html">Explore Systems</a>
          <a class="btn btn-secondary" href="/studio.html" data-launch-studio>Launch Studio</a>
        </nav> -->
      </header>

      <main class="landing__main">
        <section class="hero">
          <h1>Craft Your Own Worlds</h1>
          <p>
            Dial in atmospheres, rings, moons, and stars with science-inspired controls. Share fully
            reproducible planets in a single code.
          </p>
          <div class="hero__actions">
            <a class="btn btn-primary" href="/studio.html" data-launch-studio>Launch The Studio</a>
            <a class="btn btn-ghost" href="/explore.html">Explore Systems</a>
            <!-- <a
              class="btn btn-ghost"
              href="https://github.com/zyfod/planetCooker"
              target="_blank"
              rel="noopener noreferrer"
              >View Source</a
            > -->
          </div>
          <div class="hero__meta" aria-live="polite">
            <dl class="hero__stat">
              <dt>Total Systems Shared</dt>
              <dd id="systems-count" data-loaded="false">—</dd>
            </dl>
          </div>
          
          <div class="hero__updates">
            <h3>Latest Updates</h3>
            <div class="updates__carousel">
              <div class="updates__track">
                <div class="hero__update active">
                  <h4>Ocean & Shoreline Effects</h4>
                  <p>
                    <strong>New Water System:</strong> Added realistic ocean layers with transparent water spheres and dynamic shoreline foam! 
                    Control foam color and visibility independently. The ocean now feels like actual water with proper refraction and shoreline effects.
                  </p>
                </div>
                <div class="hero__update">
                  <h4>Independent Atmosphere Controls</h4>
                  <p>
                    <strong>Separated Controls:</strong> Atmosphere and cloud opacity are now completely independent! 
                    Create subtle atmospheres with thick clouds, or dramatic atmospheres with light clouds. 
                    Full control over both layers for more realistic planet rendering.
                  </p>
                </div>
                <div class="hero__update">
                  <h4>Enhanced Mobile Experience</h4>
                  <p>
                    <strong>Mobile Focus System:</strong> Enhanced mobile layout with intuitive controls and a new focus system! 
                    Use the eye button (👁️) in the bottom right to focus on planets, moons, and stars. 
                    The mobile interface now provides easy access to all celestial elements with optimized touch controls.
                  </p>
                </div>
                <div class="hero__update">
                  <h4>Advanced Physics & Collisions</h4>
                  <p>
                    <strong>Realistic Interactions:</strong> Improved moon physics with proper orbital mechanics, collision detection, and impact deformation. 
                    Moons now create realistic craters and surface changes when they collide with planets. 
                    Two-way gravitational interactions for more dynamic systems.
                  </p>
                </div>
              </div>
              <div class="updates__nav">
                <button class="updates__prev" aria-label="Previous update">‹</button>
                <div class="updates__dots"></div>
                <button class="updates__next" aria-label="Next update">›</button>
              </div>
            </div>
          </div>
        </section>

        <section class="preview" aria-labelledby="preview-title">
          <div class="preview__header">
            <h2 id="preview-title">Live Preview</h2>
            <p>Glance at a generated system—open the studio to make it your own.</p>
          </div>
          <div class="preview__frame">
            <iframe
              src="/studio.html?preview=1"
              title="Interactive system preview"
              loading="lazy"
              allow="accelerometer; fullscreen"
            ></iframe>
            <div class="preview__label">Preview Mode</div>
          </div>
        </section>

        <section class="recent" aria-labelledby="recent-title">
          <div class="recent__header">
            <h2 id="recent-title">Latest Shared Systems</h2>
            <a class="recent__view" href="/explore.html">See All Systems →</a>
          </div>
          <ul class="recent__list" id="recent-systems" aria-live="polite"></ul>
          <p class="recent__empty" id="recent-empty" hidden>No shared systems yet—save one from the studio to appear here.</p>
        </section>
      </main>

      <footer class="landing__footer">
        <p>
          Need to jump straight in? <a href="/studio.html" data-launch-studio>Launch the full experience</a> or explore the
          presets awaiting inside.
        </p>
      </footer>
    </div>
    <script>
      (function () {
        const params = new URLSearchParams(window.location.search);
        const previewCode = params.get("previewCode");
        const previewFrame = document.querySelector(".preview__frame iframe");
        if (previewFrame) {
          let src = "/studio.html?preview=1";
          if (previewCode) {
            src += `&load=${encodeURIComponent(previewCode)}`;
          }
          previewFrame.src = src;
        }

        if (previewCode) {
          document.querySelectorAll("[data-launch-studio]").forEach((link) => {
            link.setAttribute("href", `/studio.html#${previewCode}`);
          });
        }
      })();

      // Updates carousel functionality
      (function() {
        const track = document.querySelector('.updates__track');
        const updates = document.querySelectorAll('.hero__update');
        const prevBtn = document.querySelector('.updates__prev');
        const nextBtn = document.querySelector('.updates__next');
        const dotsContainer = document.querySelector('.updates__dots');
        
        if (!track || !updates.length) return;
        
        let currentIndex = 0;
        const totalUpdates = updates.length;
        
        // Create dots
        for (let i = 0; i < totalUpdates; i++) {
          const dot = document.createElement('div');
          dot.className = 'updates__dot';
          if (i === 0) dot.classList.add('active');
          dot.addEventListener('click', () => goToSlide(i));
          dotsContainer.appendChild(dot);
        }
        
        const dots = document.querySelectorAll('.updates__dot');
        
        function updateCarousel() {
          // Update track position
          track.style.transform = `translateX(-${currentIndex * 100}%)`;
          
          // Update active states
          updates.forEach((update, index) => {
            update.classList.toggle('active', index === currentIndex);
          });
          
          dots.forEach((dot, index) => {
            dot.classList.toggle('active', index === currentIndex);
          });
        }
        
        function goToSlide(index) {
          currentIndex = Math.max(0, Math.min(index, totalUpdates - 1));
          updateCarousel();
        }
        
        function nextSlide() {
          currentIndex = (currentIndex + 1) % totalUpdates;
          updateCarousel();
        }
        
        function prevSlide() {
          currentIndex = (currentIndex - 1 + totalUpdates) % totalUpdates;
          updateCarousel();
        }
        
        // Event listeners
        nextBtn.addEventListener('click', nextSlide);
        prevBtn.addEventListener('click', prevSlide);
        
        // Auto-advance every 8 seconds
        setInterval(nextSlide, 8000);
        
        // Touch/swipe support
        let startX = 0;
        let isDragging = false;
        
        track.addEventListener('touchstart', (e) => {
          startX = e.touches[0].clientX;
          isDragging = true;
        });
        
        track.addEventListener('touchmove', (e) => {
          if (!isDragging) return;
          e.preventDefault();
        });
        
        track.addEventListener('touchend', (e) => {
          if (!isDragging) return;
          isDragging = false;
          
          const endX = e.changedTouches[0].clientX;
          const diff = startX - endX;
          
          if (Math.abs(diff) > 50) { // Minimum swipe distance
            if (diff > 0) {
              nextSlide();
            } else {
              prevSlide();
            }
          }
        });
      })();
    </script>
    <script type="module">
      import { API_BASE_URL } from './src/app/config.js';

      const countTarget = document.getElementById('systems-count');
      if (countTarget) {
        const endpoint = `${API_BASE_URL.replace(/\/?$/, '')}/stats/count`;

        fetch(endpoint, { cache: 'no-store' })
          .then((response) => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
          })
          .then((payload) => {
            const total = Number(payload?.total);
            if (Number.isFinite(total)) {
              countTarget.textContent = total.toLocaleString();
              countTarget.dataset.loaded = 'true';
            }
          })
          .catch((err) => {
            console.warn('Unable to retrieve system count', err);
          });
      }

      const recentList = document.getElementById('recent-systems');
      const recentEmpty = document.getElementById('recent-empty');

      function formatRelativeTime(value) {
        try {
          const now = Date.now();
          const target = new Date(value).getTime();
          if (Number.isNaN(target)) return '';
          const diff = Math.max(0, now - target);

          const minute = 60 * 1000;
          const hour = 60 * minute;
          const day = 24 * hour;
          const week = 7 * day;

          if (diff < minute) return 'Just now';
          if (diff < hour) {
            const mins = Math.round(diff / minute);
            return `${mins} min${mins === 1 ? '' : 's'} ago`;
          }
          if (diff < day) {
            const hours = Math.round(diff / hour);
            return `${hours} hour${hours === 1 ? '' : 's'} ago`;
          }
          if (diff < week) {
            const days = Math.round(diff / day);
            return `${days} day${days === 1 ? '' : 's'} ago`;
          }
          const weeks = Math.round(diff / week);
          return `${weeks} week${weeks === 1 ? '' : 's'} ago`;
        } catch {
          return '';
        }
      }

      function renderRecent(items) {
        if (!recentList) return;
        recentList.innerHTML = '';

        if (!items || items.length === 0) {
          if (recentEmpty) recentEmpty.hidden = false;
          return;
        }

        if (recentEmpty) recentEmpty.hidden = true;

        items.forEach((item) => {
          const li = document.createElement('li');
          li.className = 'recent__item';

          const card = document.createElement('article');
          card.className = 'recent__card';

          const header = document.createElement('div');
          header.className = 'recent__card-header';

          const title = document.createElement('h3');
          title.className = 'recent__title';
          const displayName = item?.metadata?.name || item?.summary?.preset || `System ${item.id}`;
          title.textContent = displayName;

          const code = document.createElement('span');
          code.className = 'recent__code';
          code.textContent = `#${item.id}`;

          header.appendChild(title);
          header.appendChild(code);

          const metaList = document.createElement('dl');
          metaList.className = 'recent__meta';

          const seedLabel = document.createElement('dt');
          seedLabel.textContent = 'Seed';
          const seedValue = document.createElement('dd');
          seedValue.textContent = item?.summary?.seed || '—';

          const presetLabel = document.createElement('dt');
          presetLabel.textContent = 'Preset';
          const presetValue = document.createElement('dd');
          presetValue.textContent = item?.summary?.preset || 'Custom';

          const ageLabel = document.createElement('dt');
          ageLabel.textContent = 'Shared';
          const ageValue = document.createElement('dd');
          ageValue.textContent = formatRelativeTime(item.createdAt) || 'Recently';

          metaList.append(seedLabel, seedValue, presetLabel, presetValue, ageLabel, ageValue);

          const actions = document.createElement('div');
          actions.className = 'recent__actions';

          const loadButton = document.createElement('button');
          loadButton.type = 'button';
          loadButton.className = 'recent__action';
          loadButton.textContent = 'Load in Studio';
          loadButton.addEventListener('click', () => {
            window.location.href = `/studio.html#${item.id}`;
          });

          const copyButton = document.createElement('button');
          copyButton.type = 'button';
          copyButton.className = 'recent__action recent__action--ghost';
          copyButton.textContent = 'Copy Code';
          copyButton.addEventListener('click', async () => {
            async function legacyCopy(text) {
              return new Promise((resolve, reject) => {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.setAttribute('readonly', '');
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                textArea.style.left = '0';
                textArea.style.top = '0';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                  const ok = document.execCommand('copy');
                  document.body.removeChild(textArea);
                  if (ok) resolve(); else reject(new Error('Copy command failed'));
                } catch (err) {
                  document.body.removeChild(textArea);
                  reject(err);
                }
              });
            }

            try {
              if (navigator.clipboard && window.isSecureContext) {
                try {
                  await navigator.clipboard.writeText(item.id);
                } catch (e) {
                  await legacyCopy(item.id);
                }
              } else {
                await legacyCopy(item.id);
              }
              copyButton.textContent = 'Copied!';
              setTimeout(() => {
                copyButton.textContent = 'Copy Code';
              }, 2000);
            } catch (err) {
              console.warn('Clipboard copy failed', err);
            }
          });

          actions.append(loadButton, copyButton);

          card.append(header, metaList, actions);
          li.append(card);
          recentList.append(li);
        });
      }

      if (recentList) {
        const endpoint = `${API_BASE_URL.replace(/\/?$/, '')}/recent?limit=6`;
        fetch(endpoint, { cache: 'no-store' })
          .then((response) => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
          })
          .then((payload) => {
            renderRecent(payload?.items || []);
          })
          .catch((err) => {
            console.warn('Unable to retrieve recent systems', err);
            if (recentEmpty) recentEmpty.hidden = false;
          });
      }
    </script>
  </body>
</html>
